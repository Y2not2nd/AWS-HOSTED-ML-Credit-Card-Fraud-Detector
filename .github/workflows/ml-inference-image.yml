name: ml-inference-image

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  ECR_REPOSITORY: ${{ vars.ECR_REPOSITORY }}
  MODEL_BUCKET: ${{ vars.MODEL_BUCKET }}
  CANDIDATE_KEY: ${{ vars.CANDIDATE_KEY }}
  K8S_NAMESPACE: ml-inference
  APP_NAME: credit-fraud-inference

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: ml-platform

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS identity
        run: aws sts get-caller-identity

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Read promoted model pointer
        id: model
        run: |
          aws s3 cp s3://${MODEL_BUCKET}/${CANDIDATE_KEY} candidate.json

          MODEL_NAME=$(jq -r '.model' candidate.json)
          MODEL_TAG=$(jq -r '.tag' candidate.json)
          BENTO_PREFIX=$(jq -r '.bento_s3_prefix' candidate.json)

          SHORT_TAG=${MODEL_TAG#*:}
          IMAGE_TAG="credit-fraud-${SHORT_TAG}"

          echo "model_name=${MODEL_NAME}" >> $GITHUB_OUTPUT
          echo "model_tag=${MODEL_TAG}" >> $GITHUB_OUTPUT
          echo "bento_prefix=${BENTO_PREFIX}" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT

      - name: Build inference image
        run: |
          docker build \
            --build-arg BENTO_S3_BUCKET="${MODEL_BUCKET}" \
            --build-arg BENTO_S3_PREFIX="${{ steps.model.outputs.bento_prefix }}" \
            -t "${ECR_REPOSITORY}:${{ steps.model.outputs.image_tag }}" \
            -t "${ECR_REPOSITORY}:${{ steps.model.outputs.image_tag }}-${GITHUB_SHA::7}" \
            ml-inference-final

      - name: Push image to ECR
        run: |
          docker push ${ECR_REPOSITORY}:${{ steps.model.outputs.image_tag }}
          docker push ${ECR_REPOSITORY}:${{ steps.model.outputs.image_tag }}-${GITHUB_SHA::7}

      # -------------------------------
      # Blue Green deploy step
      # -------------------------------

      - name: Deploy to inactive colour in Kubernetes
        env:
          IMAGE_TAG: ${{ steps.model.outputs.image_tag }}
        run: |
          ACTIVE_COLOR=$(kubectl get svc ${APP_NAME} \
            -n ${K8S_NAMESPACE} \
            -o jsonpath='{.spec.selector.color}')

          if [ "$ACTIVE_COLOR" = "blue" ]; then
            NEW_COLOR="green"
          else
            NEW_COLOR="blue"
          fi

          echo "Active colour: $ACTIVE_COLOR"
          echo "Deploying to inactive colour: $NEW_COLOR"

          kubectl set image deployment/${APP_NAME}-${NEW_COLOR} \
            inference=${ECR_REPOSITORY}:${IMAGE_TAG} \
            -n ${K8S_NAMESPACE}

          kubectl rollout status deployment/${APP_NAME}-${NEW_COLOR} \
            -n ${K8S_NAMESPACE}

          kubectl patch svc ${APP_NAME} \
            -n ${K8S_NAMESPACE} \
            -p "{\"spec\":{\"selector\":{\"app\":\"${APP_NAME}\",\"color\":\"${NEW_COLOR}\"}}}"
